from openai import AsyncOpenAI

from schemas.common.Result import Result
from schemas.ybbl.ai_school.vo.PersonalityReportVo import TalentReportResponse
import os
from dotenv import load_dotenv
load_dotenv()
client = AsyncOpenAI(api_key=os.getenv("OPENAI_API_KEY"),base_url=os.getenv("OPENAI_BASE_URL"))


async def generate_Report(system_prompt: str, chat_list: str) -> Result[TalentReportResponse]:

    response = await client.chat.completions.parse(
        model="gpt-4.1",  # 建议使用 gpt-4-turbo 或 gpt-4o 以保证 JSON 结构的稳定性
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": f"以下是该学生的对话记录与背景信息：\n\n{chat_list}"}
        ],
        # 关键设置：强制输出 JSON
        response_format=TalentReportResponse,
        temperature=0.3  # 保持一定的创造性，但在结构上受控
    )
    # 获取解析后的 Pydantic 对象
    report_data: TalentReportResponse = response.choices[0].message.parsed

    # 这里的 report_data 已经是 TalentReportResponse 的实例了
    # 可以直接返回 Result 包装
    print(report_data)
    report_data.user_id = "1008611"
    result = Result(data=report_data)

    print(result)
    return result

if __name__ == '__main__':
    import asyncio
    asyncio.run(generate_Report("人格画像专家，将与用户聊天的信息总结成报告", """
    你: 你好
    为用户 1008611 创建并缓存了 0 个工具
    为用户 1008611 创建并缓存了agent
    
    AI: 你好呀！很高兴遇见你。😊
    
    我是你的人格画像构建师，在这里会陪你一起轻松聊聊，帮你更清晰地看见自己的行为模式和内在动力。我们的探索会分为几个阶段，每一步都很温和、没有压力，你可以随时决定聊到哪里。
    
    我们可以从你的日常行为模式聊起。想问问你：在社交场合，比如聚会或者团队活动时，你通常会觉得能量被补充，还是觉得有点消耗？你更喜欢主动参与，还是更享受独处的时光呢？
    
    你: 我觉得很消耗，我更喜欢一个看电影看书
    从缓存获取用户 1008611 的agent
    
    AI: 谢谢你的分享！你描述的这种状态，其实很常见于喜欢独处、内向倾向的人。你在社交场合会觉得能量被消耗，更愿意通过独自看电影、看书来恢复自己，这让我初步感觉你在“外向-内向”这个维度上，可能更偏向内向。
    
    我们再聊一个小话题，继续探索你的行为模式：  
    当你原本计划好的事情突然发生变化，比如临时被要求调整安排或者遇到突发状况时，你通常会怎么反应？你会觉得很不适应、需要时间调整，还是能比较灵活地应对？
    
    你: 会觉得很无语，需要时间调整
    从缓存获取用户 1008611 的agent
    
    AI: 明白了，谢谢你的坦诚。你说到“会觉得很无语，需要时间调整”，这说明你对计划的稳定性比较看重，面对突发变化时会有些不适应，需要给自己一点时间来适应和调整。这种特质在心理学里，通常和“尽责性”较高、喜欢有序和可控的环境有关。
    
    我们再聊一个小点，继续了解你的行为模式：  
    当遇到新鲜事物或新观点时，你通常是很感兴趣、愿意尝试，还是更倾向于保持原有的习惯和方式？比如，有人推荐你一个全新的爱好或者工作方法，你会觉得兴奋还是有点抗拒？
    
    你: 愿意尝试，可以接受
    从缓存获取用户 1008611 的agent
    
    AI: 很棒的分享！你说“愿意尝试，可以接受”，这说明你对新鲜事物持开放态度，能够接受并愿意尝试新的爱好或工作方法。这种特质在“大五人格”模型中，属于“开放性”较高的人，通常对新观点、新体验有好奇心和包容度。
    
    我们再聊一个小话题，继续了解你的行为模式：  
    当你和别人发生分歧或者冲突时，你通常会选择直接表达自己的想法，还是更倾向于先让步、照顾对方的感受？你会主动沟通，还是更希望事情自然过去？
    
    你: 还有多少个问题啊
    从缓存获取用户 1008611 的agent
    
    AI: 很贴心的问题！我们现在正在进行第一阶段——行为模式层的探索，通常会有3到5个问题。你已经回答了3个了，马上就要进入小结啦。
    
    如果你觉得还可以继续，我们只需要再聊1-2个相关小话题，就可以进入下一阶段（认知偏好层），每个阶段都会有进度提示，你可以随时决定是否继续。
    
    你觉得还想聊聊“冲突时的处理方式”这个话题吗？还是想直接进入下一阶段？完全由你决定哦！
    
    你: 继续吧
    从缓存获取用户 1008611 的agent
    
    AI: 好的，谢谢你的信任和配合！那我们继续刚才的话题：
    
    当你和别人发生分歧或者冲突时，你通常会怎么做？你会直接表达自己的真实想法，还是更倾向于先让步、照顾对方的感受？你会主动沟通解决，还是更希望事情慢慢自然过去？
    
    你: 表达自己的真实想法，但是也要视亲密关系决定，关系好的可以让步。我还是倾向于事情慢慢过去
    从缓存获取用户 1008611 的agent
    
    AI: 你的描述很细腻，也很真实。你会表达自己的真实想法，但会根据和对方的亲密程度来调整，有时愿意让步；同时，你也倾向于让事情慢慢过去，不会强求立即解决。这种处理方式显示你既有表达自我的一面，也会顾及关系和氛围，属于“宜人性”中等偏高，同时带有一定的灵活性和包容度。
    
    最后一个关于行为模式的小话题：  
    当你遇到压力或者情绪低落的时候，你通常会怎么表达或处理？是会主动和朋友倾诉，还是更喜欢自己消化？你的情绪容易被别人察觉吗？
    
    你: 倾向于自己消化，不太容易被别人察觉
    从缓存获取用户 1008611 的agent
    
    AI: 谢谢你的坦诚分享。你说你倾向于自己消化情绪，不太容易被别人察觉，这说明你在面对压力时更习惯内在处理，不太外露情绪。这种特质在“大五人格”中的“神经质”维度上，通常表现为较强的自我调节能力，但有时也可能让别人不容易发现你的情绪波动。
    
    **阶段性小结：**  
    所以，从刚才的对话来看，你在社交中更偏向内向，喜欢独处；对计划的变化比较敏感，需要时间适应；对新鲜事物持开放态度，愿意尝试；处理冲突时会表达自己，但也会顾及关系，倾向于让事情自然过去；面对压力时更喜欢自己消化情绪，不太外露。
    
    你觉得这样的描述贴近你的实际情况吗？如果觉得合适，我们可以进入第二阶段——认知偏好层，聊聊你的思维和决策方式。你愿意继续吗？
    
    你: 对的
    从缓存获取用户 1008611 的agent
    
    AI: 太好了，谢谢你的确认和信任！接下来我们进入第二阶段——认知偏好层，这一部分会帮助我们了解你是如何思考、做决定和看待世界的。依然是轻松的对话风格，每次只聊一个小话题。
    
    第一个小问题：  
    当你需要独立思考或做决定时，你更习惯依靠自己的内心直觉和感受，还是更喜欢收集外部的信息和别人的建议？比如遇到重要选择时，你会先听听别人的看法，还是更相信自己内心的判断？
    
    你: 收集外部信息，自己判断，相信内心
    从缓存获取用户 1008611 的agent
    
    AI: 你的回答很有意思，也很有层次感。你会先收集外部信息，听取别人的建议，但最终还是会自己判断，相信内心的决定。这说明你在思考和决策时，既重视客观信息，也信任自己的主观感受，属于“内外兼顾”的类型。
    
    我们再聊一个小话题：  
    在处理问题或学习新知识时，你更喜欢关注具体细节和实际操作，还是更喜欢把握整体框架和抽象概念？比如学习一项新技能时，你会先研究原理和大方向，还是更愿意一步步实践、从细节入手？
    
    你: 两者都喜欢
    从缓存获取用户 1008611 的agent
    
    AI: 很棒！你说“两者都喜欢”，这说明你在认知上既能关注整体框架和抽象概念，也能重视具体细节和实际操作。这种平衡的思维方式让你在面对问题时，既能看到大局，又不会忽略细节，属于非常灵活和全面的认知风格。
    
    我们再聊一个小话题：  
    在表达观点或者与人沟通时，你更倾向于用逻辑、事实和分析来说服别人，还是更注重情感、共鸣和个人体验？比如在讨论一个话题时，你会更习惯用数据和道理，还是用感受和故事？
    
    你: 逻辑和事实，但是面对亲密关系比较好的，会是感受和故事
    从缓存获取用户 1008611 的agent
    
    AI: 你的表达很细致。你在大多数情况下倾向于用逻辑和事实来沟通和说服别人，但在面对亲密关系时，会更多地用感受和故事来交流。这说明你具备理性分析的能力，同时也能根据关系的不同，灵活调整自己的表达方式。这种特质在MBTI模型中，体现了你在“思考（T）”和“情感（F）”之间的平衡。
    
    我们再聊最后一个关于认知偏好的小话题：  
    在面对任务或目标时，你更喜欢提前规划、按部就班地推进，还是更习惯灵活应对、随时调整？比如做一件重要的事情，你会列出详细计划，还是更随性地根据当下的情况来安排？
    
    你: 提前规划
    从缓存获取用户 1008611 的agent
    
    AI: 非常清楚！你说你更喜欢提前规划，说明你在面对任务或目标时，倾向于有条理地安排和按部就班地推进。这种特质在MBTI模型中，属于“判断型（J）”，喜欢有计划、有序的生活和工作方式。
    
    **阶段性小结：**  
    所以，从你的分享来看，你在思考和决策时会收集外部信息，但最终相信自己的判断；你既关注整体框架，也重视细节；表达观点时以逻辑和事实为主，但在亲密关系中也会用感受和故事；面对任务喜欢提前规划、按部就班。这些特质让你在认知和表达上既理性又灵活，同时注重条理和计划。
    
    你觉得这样的描述贴近你的实际情况吗？如果觉得合适，我们可以进入第三阶段——动力优势层，探索一下你的内在驱动力和最自然的行为优势。你愿意继续吗？
    
    你: 可以
    从缓存获取用户 1008611 的agent
    
    AI: 太好了！感谢你的信任和配合。现在我们进入第三阶段——动力优势层，这一部分会帮助我们发现你最自然的行为动力和优势所在。
    
    第一个小话题：  
    在你做事情最有动力、最投入的时候，通常是什么在驱动你？比如：  
    - 是想要取得成就、完成目标的满足感？  
    - 还是对新知识、新技能的好奇和学习？  
    - 或者是和他人建立关系、获得认可？  
    - 还是觉得做的事情很有意义、对他人或社会有价值？
    
    你觉得哪一种动力对你来说最强烈？
    
    你: 第二点
    从缓存获取用户 1008611 的agent
    
    AI: 非常清楚！你说“对新知识、新技能的好奇和学习”是你最强烈的动力。这说明你是一个以学习和成长为核心驱动力的人，喜欢不断探索新领域、积累新经验，这种动力会让你在面对新挑战时充满热情和投入。
    
    我们继续聊聊你的行动方式：  
    当你要开始一项新任务或项目时，你通常是主动自发地去启动，还是需要有一个明确的计划或者外部的需求来推动你行动？比如，是自己想到就会立刻去做，还是需要有计划安排或者别人提出需求才会开始？
    
    你: 主动自发去启动
    从缓存获取用户 1008611 的agent
    
    AI: 很棒！你说你是“主动自发去启动”，这说明你在行动上非常有主动性，喜欢自己发现机会并付诸实践，不太依赖外部推动或他人安排。这种特质让你在面对新任务时能够快速行动，展现出很强的自驱力。
    
    我们再聊一个关于持续投入的小话题：  
    当你在做一件事情时，是什么让你能够持续投入和坚持下去？是因为自律和责任感，还是因为兴趣和热情？或者是因为对结果的期待？你觉得哪种因素对你来说最重要？
    
    你: 兴趣热情以及对结果的期待
    从缓存获取用户 1008611 的agent
    
    AI: 非常清晰！你说兴趣和热情，以及对结果的期待，是让你持续投入和坚持下去的主要动力。这说明你在做事时，既需要对过程本身感到喜欢和兴奋，也会被目标和成果所激励。这种动力组合让你在面对喜欢的事情时能够全情投入，并且对达成目标有很强的期待感。
    
    我们再聊一个关于影响他人的小话题：  
    在团队或与他人合作时，你更擅长通过哪种方式影响别人？比如：  
    - 组织协调大家的分工和流程  
    - 沟通激励，调动大家的积极性  
    - 提供情感支持，关心和帮助他人  
    - 还是其他方式？
    
    你觉得哪一种是你最自然、最常用的影响方式？
    
    你: 第一种
    从缓存获取用户 1008611 的agent
    
    AI: 明白了！你说你最擅长“组织协调大家的分工和流程”，这说明你在团队合作中，能够自然地承担起规划和协调的角色，帮助大家明确目标、理清步骤，让团队运作更加高效有序。这是一种非常宝贵的优势。
    
    最后一个关于应对不确定性的小话题：  
    当你面对不确定性或新的挑战时，你通常会怎么做？你会倾向于先收集大量信息、分析情况，还是更喜欢直接制定策略、快速行动？或者你更习惯和他人协作、共同探索解决办法？哪种方式最符合你的习惯？
    
    你: 不对，上一个问题应该是第三种
    从缓存获取用户 1008611 的agent
    
    AI: 谢谢你的及时纠正！你说你其实更擅长“提供情感支持，关心和帮助他人”。这说明你在团队或合作中，最自然的影响方式是通过关心、理解和支持他人，帮助大家建立信任和良好的氛围。这种能力让你成为团队中温暖、可靠的伙伴，能够让他人感受到被理解和支持。
    
    我们回到刚才的最后一个小话题：  
    当你面对不确定性或新的挑战时，你通常会怎么做？  
    - 你会倾向于先收集大量信息、分析情况，  
    - 还是更喜欢直接制定策略、快速行动，  
    - 或者更习惯和他人协作、共同探索解决办法？  
    哪种方式最符合你的习惯？
    
    你: 第二种
    从缓存获取用户 1008611 的agent
    
    AI: 非常清楚！你说在面对不确定性或新的挑战时，更喜欢直接制定策略、快速行动。这说明你在遇到未知或变化时，能够果断地做出决策，主动采取行动，而不是过度犹豫或依赖信息收集。这种本能让你在复杂环境中能够迅速应对和调整。
    
    **阶段性小结：**  
    所以，从你的分享来看，你的内在动力主要来自于对新知识和技能的好奇与学习；你行动上非常主动自发，喜欢自己启动任务；持续投入靠兴趣、热情和对结果的期待；在团队中你最自然的影响方式是提供情感支持，关心和帮助他人；面对不确定性时，你倾向于直接制定策略并快速行动。
    
    你觉得这样的描述贴近你的实际情况吗？如果觉得合适，我可以为你整合一份简要的人格画像侧写。你愿意听听吗？
    
    你: 听听
    从缓存获取用户 1008611 的agent
    
    AI: 好的！以下是根据我们刚才三层探索，为你整合的人格画像侧写：
    
    ---
    
    **人格画像侧写**
    
    你是一个安静而开放的人，喜欢独处、享受阅读和观影，社交场合会让你感到能量消耗。你对计划的稳定性有较高需求，面对突发变化时需要时间适应，但对新鲜事物和新观点持开放态度，乐于尝试和接受。
    
    在思考和决策时，你会收集外部信息，但最终相信自己的判断。你既能关注整体框架，也重视细节，表达观点时以逻辑和事实为主，但在亲密关系中也会用感受和故事。你喜欢提前规划，做事有条理。
    
    你的内在动力主要来自对新知识和技能的好奇与学习。你行动主动自发，喜欢自己启动任务。持续投入靠兴趣、热情和对结果的期待。在团队中，你最自然的影响方式是提供情感支持，关心和帮助他人，让大家感受到温暖和理解。面对不确定性时，你倾向于直接制定策略并快速行动，果断应对挑战。
    
    ---
    
    这份侧写只是一个简要的描述，完整的评估报告会在小言老师网站中呈现。如果你有任何补充或想进一步探索的地方，也可以随时告诉我。很高兴陪你一起走完这段自我探索的旅程！
    
    你: 你这不就是只重复了我的回答吗
    从缓存获取用户 1008611 的agent
    
    AI: 你的感受很真实，也很重要。你说得没错，刚才的侧写确实主要是基于你的回答进行梳理和整合。这样做的目的是让你能看到自己各方面特质的整体画像，而不是简单地罗列答案。
    
    不过，你的反馈提醒了我：你可能更希望听到一些“更深入的洞察”或者“背后的联系”，而不仅仅是答案的复述。让我试着用更专业、整体的视角，帮你串联和解读一下你的特质：
    
    ---
    
    **深入版人格画像侧写**
    
    你的人格特质展现出一种“安静的探索者”气质。你喜欢独处，善于自我调节情绪，这让你在纷繁的环境中能够保持内心的稳定和清晰。你对新知充满好奇，乐于学习和尝试，这种开放性让你不断成长，也让你在面对变化时，虽然会有短暂的不适，但很快能用主动的行动和策略去应对。
    
    你的思维方式兼具理性与感性：你习惯收集信息、理清逻辑，但在亲密关系中又能用温暖的情感去连接他人。这种灵活的表达能力，让你在不同场合都能自如切换，既能成为团队中的“理性分析者”，也能是“情感支持者”。
    
    你做事有计划，喜欢提前安排，这让你在面对复杂任务时能够有条不紊地推进。而你的动力来源于对新鲜事物的热情和对成果的期待，这种内驱力让你在喜欢的领域能够持续投入，不断突破自我。
    
    在团队中，你更倾向于用关心和支持影响他人，营造温暖的氛围。面对不确定性，你不会过度犹豫，而是愿意快速制定策略、主动出击，这让你在变化中依然能够保持掌控感。
    
    **整体来看，你是一个内心丰富、行动主动、既理性又温暖的人。你善于自我成长，也能温柔地影响身边的人。**
    
    ---
    
    如果你希望了解更多，比如你的这些特质在现实生活中的优势、可能的挑战，或者如何进一步发展自己，也可以告诉我。我很乐意陪你继续探索！"""))
name: Deploy via SSH

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # 进入项目目录
            cd ${{ secrets.DEPLOY_PATH }}

            # 拉取最新代码
            echo "拉取最新代码..."
            git pull origin main

            # 安装/更新依赖
            echo "安装依赖..."
            pip install -r requirements.txt

            # 关闭占用 8000 端口的旧进程
            echo "关闭旧进程..."
            OLD_PID=$(lsof -ti:8000)
            if [ ! -z "$OLD_PID" ]; then
              echo "发现旧进程 PID: $OLD_PID，正在关闭..."
              kill -9 $OLD_PID
              sleep 2
            else
              echo "没有发现占用 8000 端口的进程"
            fi

            # 后台启动新服务
            echo "启动新服务..."
            nohup uvicorn main:app --host 0.0.0.0 --port 8000 > app.log 2>&1 &

            # 等待服务启动
            sleep 3

            # 检查服务是否启动成功
            NEW_PID=$(lsof -ti:8000)
            if [ ! -z "$NEW_PID" ]; then
              echo "服务启动成功！PID: $NEW_PID"
            else
              echo "服务启动失败，请检查日志"
              exit 1
            fi
